---
title: "零碎的点"
type: concept
domain: ai/agent/multi-agent
created: "2026-02-13"
updated: "2026-02-13"
tags:
  - ai/agent/multi-agent
  - type/concept
---
# Multi-Agent 零碎思考

记录在做 Multi-Agent 相关调研和实践中的碎片化思考。

## 任务拆分是核心

- 查询大数据量的任务最好要拆分。一个 Agent 处理全量数据容易超时或 context 溢出
- 拆分粒度是个艺术：太细了 Agent 间通信开销大，太粗了单个 Agent 负担重
- 经验法则：按**数据分区**或**处理阶段**拆分，跟 MapReduce 的思路一样

## 通信模式

### 1. 中心化（Orchestrator 模式）

```
         ┌─────────┐
         │ 编排者   │
         └────┬────┘
        ┌─────┼─────┐
        ▼     ▼     ▼
     Agent1 Agent2 Agent3
```

优点：控制流清晰，容易 debug
缺点：编排者是单点瓶颈，复杂任务的编排逻辑会变得很臃肿

### 2. 去中心化（对话模式）

```
Agent1 ←→ Agent2 ←→ Agent3
  ↑                    │
  └────────────────────┘
```

优点：灵活，Agent 之间可以动态协商
缺点：容易陷入无限对话循环，难以保证收敛

### 3. 分层（Hierarchical）

```
     高层决策 Agent
      ├── 中层规划 Agent
      │     ├── 执行 Agent A
      │     └── 执行 Agent B
      └── 中层规划 Agent
            └── 执行 Agent C
```

这是我认为最实用的模式。类似公司的组织架构——CEO 不需要知道每个细节，只需要管好几个 VP。

## 状态管理

Multi-Agent 系统最头疼的问题是状态同步：

```python
# 反模式：每个 Agent 维护自己的状态
agent1.state = {"data": [...]}  # Agent 2 看不到

# 推荐：共享状态存储
class SharedState:
    def __init__(self):
        self.store = {}
        self.lock = asyncio.Lock()
    
    async def update(self, key, value, agent_id):
        async with self.lock:
            self.store[key] = {
                "value": value,
                "updated_by": agent_id,
                "timestamp": time.time()
            }
```

## 错误处理

单 Agent 挂了不应该导致整个系统崩溃：

- **重试**：幂等的操作直接重试
- **降级**：某个 Agent 不可用时用备选方案
- **超时**：给每个 Agent 设置 deadline，超时就 kill
- **熔断**：连续失败 N 次后暂停分配任务给该 Agent

## 框架选择

| 框架 | 适合场景 | 备注 |
|------|----------|------|
| CrewAI | 快速原型 | 简单但不够灵活 |
| AutoGen | 研究探索 | 微软出品，对话驱动 |
| LangGraph | 生产部署 | 状态机模式，可控性强 |
| 自建 | 特定需求 | 复杂但最灵活 |

我的建议：先用 LangGraph 跑通 POC，确认需求后再决定要不要自建。

## 踩过的坑

1. **不要让 Agent 互相调用 LLM**——成本会指数爆炸
2. **日志要聚合**——分散在各 Agent 里的日志查 bug 会让你崩溃
3. **设置 token 预算**——一个失控的 Agent 可以一晚上烧掉你一个月的 API 费
4. **评估要端到端**——单个 Agent 表现好不代表组合起来表现好

## 相关

- [[AI/Agent/Multi-Agent/untitled_SB2HwKNC|Multi-Agent 架构]]
- [[AI/AI 综合|AI 综合]]
- [[AI/LLM/Prompt-Engineering/Prompt engineering 概述|Prompt Engineering 概述]]
