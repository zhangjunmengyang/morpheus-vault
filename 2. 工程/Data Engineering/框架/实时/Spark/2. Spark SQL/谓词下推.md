# 谓词下推

## 谓词下推

### 谓词下推概念

谓词下推 Predicate Pushdown（PPD）：

- 将过滤条件从计算进程下推到存储进程先行执行
- 注意这里有两种类型进程：计算进程以及存储进程。计算与存储分离思想，这在大数据领域相当常见，比如最常见的计算进程有SparkSQL、Hive、impala等，负责SQL解析优化、数据计算聚合等，存储进程有HDFS（DataNode）、Kudu、HBase，负责数据存储。
- **正常情况下应该是将所有数据从存储进程加载到计算进程，再进行过滤计算。谓词下推是说将一些过滤条件下推到存储进程，直接让存储进程将数据过滤掉。**这样的好处显而易见，过滤的越早，数据量越少，序列化开销、网络开销、计算开销这一系列都会减少，性能自然会提高。
对于hive的分区表而言，谓词下推可以再进一步，下推到元数据中，根据元数据返回的分区信息，map的输入端只用扫描对应的分区文件而不是全表扫描，减少了map端的输入，更进一步提升性能。

### 相关定义

**Preserved Row table**

The table in an Outer Join that must return all rows.

For left outer joins this is the Left table, for right outer joins it is the Right table, and for full outer joins both tables are Preserved Row tables.

**Null Supplying table**

This is the table that has nulls filled in for its columns in unmatched rows.

In the non-full outer join case, this is the other table in the Join. For full outer joins both tables are also Null Supplying tables.

**During Join predicate**

A predicate that is in the JOIN ON clause.

For example, in ‘R1 join R2 on R1.x = 5’ the predicate ‘R1.x = 5’ is a During Join predicate.

**After Join predicate**

A predicate that is in the WHERE clause.

**PPD规则的逻辑描述如下：**

During Join predicates cannot be pushed past Preserved Row tables.

After Join predicates cannot be pushed past Null Supplying tables.

以表格的形式描述如下：

![image](assets/SG4QdVT6VoMmg7xgxmlcWBRGnHb.png)

实验结果表格形式：

![image](assets/XJqSdOs7IoMThIxT4aDctCf9nmg.png)

**结论**

1. 对于Join(Inner Join)、Full outer Join，条件写在on后面，还是where后面，性能上面没有区别；
1. 对于Left outer Join ，右侧的表写在on后面、左侧的表写在where后面，性能上有提高；
1. 对于Right outer Join，左侧的表写在on后面、右侧的表写在where后面，性能上有提高；
1. 当条件分散在两个表时，谓词下推可按上述结论2和3自由组合，情况如下：