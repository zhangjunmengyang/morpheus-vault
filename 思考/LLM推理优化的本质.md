---
title: LLM æ¨ç†ä¼˜åŒ–çš„æœ¬è´¨
type: æ€è€ƒ
date: 2026-02-26
tags:
  - ai/llm/inference
  - æ€è€ƒ
  - optimization
  - serving
  - kv-cache
---

# LLM æ¨ç†ä¼˜åŒ–çš„æœ¬è´¨

> æ¨ç†ä¼˜åŒ–ä¸æ˜¯ä¸€å †æ•£è£…æŠ€å·§ã€‚å®ƒæ˜¯ä¸€åœºåœ¨ memory-bound ç‰©ç†çº¦æŸä¸‹çš„å·¥ç¨‹åšå¼ˆâ€”â€”æ‰€æœ‰æŠ€æœ¯è·¯çº¿éƒ½åœ¨å›ç­”åŒä¸€ä¸ªé—®é¢˜ï¼š**æ€ä¹ˆè®© GPU å°‘æ¬æ•°æ®ã€å¤šå¹²æ´»ï¼Ÿ**

---

## ä¸€ã€ç¬¬ä¸€æ€§åŸç†ï¼šä¸ºä»€ä¹ˆæ¨ç†æ…¢ï¼Ÿ

LLM æ¨ç†æœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œæ€§è´¨å®Œå…¨ä¸åŒï¼š

| | Prefillï¼ˆåƒ promptï¼‰ | Decodeï¼ˆå tokenï¼‰ |
|---|---|---|
| **è®¡ç®—æ¨¡å¼** | å¤§çŸ©é˜µä¹˜æ³•ï¼Œå¹¶è¡Œå¤„ç†æ•´ä¸ª prompt | é€€åŒ–çš„ matrix-vector ä¹˜æ³•ï¼Œæ¯æ¬¡åªç®— 1 ä¸ª token |
| **ç“¶é¢ˆ** | Compute-boundï¼ˆç®—åŠ›ï¼‰ | Memory-boundï¼ˆå¸¦å®½ï¼‰ |
| **æ ¸å¿ƒæŒ‡æ ‡** | TTFTï¼ˆé¦– token å»¶è¿Ÿï¼‰ | TPOTï¼ˆæ¯ token å»¶è¿Ÿï¼‰ |
| **ä¼˜åŒ–æ–¹å‘** | æé«˜ç®—åŠ›åˆ©ç”¨ç‡ | å‡å°‘æ•°æ®æ¬è¿ |

**Decode ä¸ºä»€ä¹ˆ memory-boundï¼Ÿ** ä¸€ä¸ªæ•°å€¼ç›´è§‰å°±å¤Ÿäº†ï¼š70B æ¨¡å‹ï¼ˆFP16ï¼‰æƒé‡ 140GBã€‚æ¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œè¦æŠŠ 140GB å…¨éƒ¨ä»æ˜¾å­˜åŠ è½½ä¸€éï¼Œä½†åªåš 280 GFLOP è®¡ç®—ã€‚åœ¨ A100 ä¸Šï¼ŒåŠ è½½è¦ 70msï¼Œè®¡ç®—åªè¦ 0.9msã€‚**æ¬æ•°æ®çš„æ—¶é—´æ˜¯è®¡ç®—æ—¶é—´çš„ 78 å€ã€‚**

è¿™å°±æ˜¯ä¸€åˆ‡æ¨ç†ä¼˜åŒ–çš„ç‰©ç†æ ¹æºã€‚

---

## äºŒã€æ ¸å¿ƒæˆ˜åœºï¼šKV Cache

KV Cache æ˜¯æ¨ç†ä¼˜åŒ–çš„æ¢çº½â€”â€”å‡ ä¹æ‰€æœ‰ä¼˜åŒ–æŠ€æœ¯æœ€ç»ˆéƒ½å’Œå®ƒæœ‰å…³ã€‚

**é—®é¢˜æœ¬è´¨ï¼š** è‡ªå›å½’ç”Ÿæˆå¿…é¡»è®°ä½æ‰€æœ‰å†å² token çš„ Key å’Œ Valueã€‚70B æ¨¡å‹å•è¯·æ±‚ 4K é•¿åº¦çš„ KV Cache â‰ˆ 1.3GBï¼Œå¹¶å‘ 32 è¯·æ±‚ç›´æ¥åƒæ‰ 42GB æ˜¾å­˜ã€‚KV Cache é™åˆ¶äº† batch sizeï¼Œbatch size é™åˆ¶äº†ååâ€”â€”è¿™æ˜¯ä¸€æ¡ä»æ˜¾å­˜åˆ°é’±çš„å› æœé“¾ã€‚

**å››æ¡å‹ç¼©è·¯çº¿ï¼Œå„æœ‰ä»£ä»·ï¼š**

| è·¯çº¿ | ä»£è¡¨ | å‹ç¼©æ¯” | ä»£ä»· | æˆ‘çš„åˆ¤æ–­ |
|------|------|--------|------|----------|
| **å‡å°‘ KV head æ•°** | GQAï¼ˆLLaMA-2ï¼‰ã€MQAï¼ˆFalconï¼‰ | 4-64Ã— | è¡¨è¾¾åŠ›ä¸‹é™ï¼ˆå¯æ§ï¼‰ | GQA æ˜¯å½“å‰æœ€ç¨³çš„é»˜è®¤é€‰æ‹© |
| **ä½ç§©å‹ç¼©** | MLAï¼ˆDeepSeek-V2/V3ï¼‰ | ~28Ã— | éœ€è¦ RoPE è§£è€¦ï¼Œå·¥ç¨‹å¤æ‚ | æœ€ä¼˜é›…çš„æ–¹æ¡ˆï¼Œä½† DeepSeek ç‹¬å®¶ |
| **é‡åŒ–** | KV Cache INT8/FP8 | 2-4Ã— | å‡ ä¹æ— æŸ | **å…è´¹åˆé¤ï¼Œåº”è¯¥é»˜è®¤å¼€å¯** |
| **ä¸¢å¼ƒ** | Sliding Window + Attention Sink | ç†è®ºæ— é™ | ä¸¢å¤±è¿œè·ç¦»ä¿¡æ¯ | é•¿åºåˆ—æ¨ç†çš„å®ç”¨æ–¹æ¡ˆ |

**MLA çš„æ ¸å¿ƒæ´å¯Ÿå€¼å¾—å¤šè¯´ä¸€å¥ï¼š** ä¸ç›´æ¥ç¼“å­˜ Kã€Vï¼Œè€Œæ˜¯ç¼“å­˜ä¸€ä¸ªä½ç»´ latent vectorï¼Œæ¨ç†æ—¶ç”¨ absorption trick æŠŠæ¢å¤çŸ©é˜µå¸æ”¶è¿› query æŠ•å½±â€”â€”ç›´æ¥åœ¨å‹ç¼©ç©ºé—´åš attentionï¼Œæ ¹æœ¬ä¸éœ€è¦å±•å¼€ Kã€‚è¿™ä¸æ˜¯å·¥ç¨‹å¦¥åï¼Œæ˜¯æ•°å­¦ä¸Šçš„å·§å¦™ã€‚DeepSeek-V3 ç”¨å®ƒæŠŠ KV Cache ä» 16384 ç»´å‹åˆ° 576 ç»´ï¼Œè´¨é‡ä¸é™åå‡ã€‚

---

## ä¸‰ã€ä¸¤æŠŠåˆ€ï¼šFlashAttention å’Œ PagedAttention

è¿™ä¸¤ä¸ªç»å¸¸è¢«æ··æ·†ï¼Œä½†å®ƒä»¬è§£å†³çš„æ˜¯å®Œå…¨ä¸åŒçš„é—®é¢˜ï¼š

- **FlashAttention** è§£å†³ã€Œattention æ€ä¹ˆç®—æ›´å¿«ã€â€”â€” Tiling + Online Softmax + Kernel Fusionï¼Œè®© NÃ—N çš„ attention çŸ©é˜µæ°¸è¿œä¸å†™å› HBMã€‚FLOPS æ²¡å‡å°‘ï¼Œ**IO å‡å°‘äº†**ã€‚é€Ÿåº¦æå‡ 2-4Ã— çº¯ç²¹æ˜¯å› ä¸ºå°‘æ¬äº†æ•°æ®ã€‚
- **PagedAttention** è§£å†³ã€ŒKV Cache æ€ä¹ˆå­˜æ›´çœã€â€”â€” å€Ÿé‰´ OS è™šæ‹Ÿå†…å­˜åˆ†é¡µï¼ŒæŒ‰éœ€åˆ†é… blockï¼Œæ¶ˆç­ç¢ç‰‡ã€‚æ˜¾å­˜åˆ©ç”¨ç‡ä» 20-40% æå‡åˆ° 96%ã€‚

**ä¸¤è€…å¿…é¡»ç»„åˆä½¿ç”¨**ï¼Œè¿™æ˜¯ 2026 å¹´ LLM serving çš„åº•çº¿é…ç½®ã€‚

---

## å››ã€Decode åŠ é€Ÿçš„èŒƒå¼è½¬å˜ï¼šæŠ•æœºè§£ç 

è‡ªå›å½’ decode çš„æ ¹æœ¬çŸ›ç›¾ï¼šæ¯ä¸ª token éœ€è¦ä¸€æ¬¡å®Œæ•´å‰å‘ä¼ æ’­ï¼Œä½†å› ä¸º memory-boundï¼ŒGPU ç®—åŠ›å¤§é‡ç©ºé—²ã€‚

æŠ•æœºè§£ç çš„æ ¸å¿ƒæ´å¯Ÿï¼š**éªŒè¯æ¯”ç”Ÿæˆä¾¿å®œã€‚** Memory-bound ä¸‹ï¼ŒéªŒè¯ 10 ä¸ª token çš„æˆæœ¬ â‰ˆ ç”Ÿæˆ 1 ä¸ª tokenã€‚

| æ–¹æ¡ˆ | åšæ³• | åŠ é€Ÿæ¯” | æ˜¯å¦æ— æŸ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|----------|----------|
| **æ ‡å‡† Speculative Decoding** | å°æ¨¡å‹ draft + å¤§æ¨¡å‹ verify + rejection sampling | 2-3Ã— | âœ… æ•°å­¦ä¸¥æ ¼ç­‰ä»· | æœ‰åŒç³»åˆ—å°æ¨¡å‹æ—¶ |
| **Medusa** | åœ¨å¤§æ¨¡å‹ä¸ŠåŠ é¢„æµ‹å¤´ï¼Œæ ‘å½¢éªŒè¯ | 2-3Ã— | âŒ éœ€å¾®è°ƒ | ä¸æƒ³ç»´æŠ¤é¢å¤–æ¨¡å‹æ—¶ |
| **EAGLE** | åœ¨ hidden state å±‚åšè‡ªå›å½’ draft | 3-4Ã— | âœ… è¿‘ä¼¼æ— æŸ | è¿½æ±‚æœ€é«˜åŠ é€Ÿæ¯”æ—¶ |

**æ ‡å‡†æŠ•æœºè§£ç çš„æ•°å­¦ä¿è¯æ˜¯å®ƒæœ€å¤§çš„å–ç‚¹ï¼š** é€šè¿‡ rejection samplingï¼Œæœ€ç»ˆè¾“å‡ºåˆ†å¸ƒä¸¥æ ¼ç­‰äº target modelâ€”â€”è¿™ä¸æ˜¯è¿‘ä¼¼ï¼Œæ˜¯è¯æ˜ã€‚å¯¹äºä¸èƒ½å®¹å¿ä»»ä½•è´¨é‡æŸå¤±çš„åœºæ™¯ï¼Œè¿™æ˜¯å”¯ä¸€çš„å…è´¹åˆé¤ã€‚

**ä»€ä¹ˆæ—¶å€™æŠ•æœºè§£ç æ•ˆæœå·®ï¼Ÿ** å¼€æ”¾æ€§åˆ›æ„å†™ä½œã€‚å› ä¸º acceptance rate å–å†³äº draft-target åˆ†å¸ƒå¯¹é½åº¦ï¼Œå‘æ•£æ€§å¤§çš„ä»»åŠ¡å¯¹é½åº¦ä½ï¼ŒåŠ é€Ÿæ¯”å¯èƒ½ä¸åˆ° 2Ã—ã€‚

---

## äº”ã€ç³»ç»Ÿçº§ä¼˜åŒ–ï¼šæŠŠ GPU å–‚é¥±

å•ç‚¹æŠ€æœ¯ä¹‹ä¸Šï¼Œæ˜¯ç³»ç»Ÿçº§çš„ç¼–æ’ï¼š

**Continuous Batching** æ˜¯åŸºæœ¬åŠŸâ€”â€”åœ¨æ¯ä¸ª decode step çº§åˆ«è°ƒåº¦ï¼Œè¯·æ±‚å®Œæˆç«‹å³é‡Šæ”¾ã€æ–°è¯·æ±‚ç«‹å³åŠ å…¥ï¼ŒGPU æ°¸è¿œæ»¡è½½ã€‚ç›¸æ¯” static batching ååæå‡ 2-8Ã—ã€‚2026 å¹´æ‰€æœ‰ serving æ¡†æ¶æ ‡é…ã€‚

**Chunked Prefill** è§£å†³ä¸€ä¸ªè¢«å¿½è§†çš„é—®é¢˜ï¼šé•¿ prompt çš„ prefillï¼ˆcompute-boundï¼‰ä¼šé˜»å¡åŒ batch ä¸­çš„ decode è¯·æ±‚ï¼Œå¯¼è‡´å»¶è¿Ÿå°–å³°ã€‚æŠŠ prefill åˆ‡æˆ 512-2048 token çš„ chunkï¼Œå’Œ decode æ··åˆè°ƒåº¦ï¼ŒP99 å»¶è¿Ÿæ”¹å–„ 3-5Ã—ã€‚

**PD åˆ†ç¦»ï¼ˆDisaggregated Prefill-Decodeï¼‰** æ˜¯ç»ˆæå½¢æ€ï¼šPrefill å’Œ Decode è®¡ç®—ç‰¹å¾å®Œå…¨ä¸åŒï¼Œä¸ºä»€ä¹ˆè¦åœ¨åŒä¸€ç»„ GPU ä¸Šæ··è·‘ï¼Ÿåˆ†ç¦»åå„è‡ªç‹¬ç«‹ scalingâ€”â€”Prefill é›†ç¾¤è¿½æ±‚é«˜ç®—åŠ›åˆ©ç”¨ç‡ï¼ŒDecode é›†ç¾¤è¿½æ±‚é«˜ batch sizeã€‚DeepSeek-V3 çš„çº¿ä¸Š serving å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚ä»£ä»·æ˜¯ KV Cache è¿ç§»çš„å¸¦å®½å¼€é”€å’Œè°ƒåº¦å¤æ‚åº¦ã€‚

---

## å…­ã€é‡åŒ–ï¼šéƒ¨ç½²çš„ç°å®é€‰æ‹©

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|------|---------|------|
| H100/B100 é›†ç¾¤ | FP8 PTQ | å‡ ä¹æ— æŸï¼ŒTensor Core åŸç”Ÿ 2Ã— åŠ é€Ÿ |
| A100/4090 | AWQ INT4 | ç¡¬ä»¶å‹å¥½ï¼Œé€Ÿåº¦å’Œè´¨é‡æœ€ä½³å¹³è¡¡ |
| Mac/è¾¹ç¼˜è®¾å¤‡ | GGUF Q4_K_M | Metal ä¼˜åŒ–ï¼Œllama.cpp ç”Ÿæ€å®Œå–„ |
| æè‡´å‹ç¼© | QATï¼ˆAQLM/QuIP#ï¼‰ | éœ€è¦é‡è®­ï¼Œä½† INT2 çº§åˆ«ä»å¯ç”¨ |

**ä¸€ä¸ªå®ç”¨åˆ¤æ–­ï¼š** GPTQ vs AWQ çš„é€‰æ‹©ä¸é‡è¦â€”â€”ä¸¤è€…è´¨é‡ç›¸å½“ã€‚AWQ æ ¼å¼æ›´ç¡¬ä»¶å‹å¥½ï¼Œéƒ¨ç½²ç®€å•ï¼›GPTQ æ•°å­¦ä¸Šæ›´ä¸¥è°¨ï¼Œgroup_size=128 æ—¶ç²¾åº¦ç•¥ä¼˜ã€‚åˆ«åœ¨è¿™é‡Œçº ç»“ï¼Œçœä¸‹æ—¶é—´åš KV Cache é‡åŒ–ï¼ˆè¿™æ‰æ˜¯çœŸæ­£çš„å…è´¹åˆé¤ï¼‰ã€‚

---

## ä¸ƒã€æ¡†æ¶é€‰å‹ï¼šä¸€å¼ è¡¨å¤Ÿäº†

| åœºæ™¯ | é€‰ | æ ¸å¿ƒç†ç”± |
|------|---|---------|
| é€šç”¨ç”Ÿäº§ serving | vLLM | æœ€ç¨³å®šã€æ¨¡å‹æ”¯æŒæœ€å…¨ã€ç¤¾åŒºæœ€å¤§ |
| Agent / ç»“æ„åŒ–è¾“å‡º | SGLang | RadixAttention å‰ç¼€ç¼“å­˜ + Compressed FSM |
| NVIDIA æè‡´å•å¡æ€§èƒ½ | TensorRT-LLM | kernel çº§æ·±åº¦ä¼˜åŒ–ï¼Œä½†é—­æºã€è¿­ä»£æ…¢ |
| Mac æœ¬åœ° / è¾¹ç¼˜ | llama.cpp | è·¨å¹³å°ã€GGUF é‡åŒ–ã€é›¶ä¾èµ– |

---

## å…«ã€æˆ‘çš„åˆ¤æ–­

1. **æ¨ç†ä¼˜åŒ–çš„æœ¬è´¨æ˜¯å¯¹æŠ— memory wallã€‚** æ‰€æœ‰æŠ€æœ¯â€”â€”FlashAttention å‡å°‘ IOã€é‡åŒ–å‡å°æ•°æ®é‡ã€æŠ•æœºè§£ç æŠŠä¸²è¡Œå˜å¹¶è¡Œã€å¤§ batch æ‘Šè–„æƒé‡åŠ è½½â€”â€”éƒ½æ˜¯åœ¨ memory-bound çº¦æŸä¸‹çš„ä¸åŒåšå¼ˆç­–ç•¥ã€‚ç†è§£è¿™ä¸€ç‚¹æ¯”è®°ä½ä»»ä½•å•é¡¹æŠ€æœ¯éƒ½é‡è¦ã€‚

2. **KV Cache æ˜¯æ æ†ç‚¹ã€‚** çœ 1 å­—èŠ‚ KV Cache = å¤šå¡ 1 ä¸ªå¹¶å‘è¯·æ±‚ = å¤šèµš 1 ä»½é’±ã€‚MLA > GQA > MQA æ˜¯å‹ç¼©æ•ˆç‡çš„æ’åºï¼Œä½† MLA ç›®å‰åªæœ‰ DeepSeek åœ¨ç”¨ã€‚GQA + INT8 KV Cache æ˜¯å½“å‰æœ€å®ç”¨çš„ç»„åˆã€‚

3. **PD åˆ†ç¦»æ˜¯ä¸‹ä¸€ä»£ serving æ¶æ„çš„æ–¹å‘ã€‚** æ··åˆ Prefill-Decode æ˜¯å·¥ç¨‹å¦¥åï¼Œåˆ†ç¦»åæ‰èƒ½è®©ä¸¤ç§è®¡ç®—æ¨¡å¼å„è‡ªè¾¾åˆ°æœ€ä¼˜ã€‚ä½†è¿™éœ€è¦é«˜é€Ÿäº’è¿å’Œå¤æ‚è°ƒåº¦â€”â€”å°å›¢é˜Ÿæš‚æ—¶ç”¨ Chunked Prefill è¿‡æ¸¡ã€‚

4. **æŠ•æœºè§£ç æ­£åœ¨ä»å­¦æœ¯èµ°å‘æ ‡é…ã€‚** EAGLE-2 çš„ 3-4Ã— åŠ é€Ÿæ¯”å·²ç»å¾ˆå®ç”¨ã€‚éšç€ framework åŸç”Ÿæ”¯æŒï¼ˆvLLM/SGLang éƒ½å·²é›†æˆï¼‰ï¼Œä½¿ç”¨é—¨æ§›åœ¨å¿«é€Ÿé™ä½ã€‚

5. **6 ä¸ªæœˆé¢„æµ‹ï¼š** FP4 é‡åŒ–æˆç†Ÿ + ç«¯ä¾§ä¸“ç”¨èŠ¯ç‰‡ï¼ˆApple M5ã€é«˜é€š Snapdragon Xï¼‰+ æ›´æ¿€è¿›çš„ KV Cache å‹ç¼©ï¼Œå°†ä½¿ 13B æ¨¡å‹åœ¨æ‰‹æœºä¸Šæµç•…è¿è¡Œã€‚æ¨ç†ä¼˜åŒ–çš„æˆ˜åœºæ­£åœ¨ä»äº‘ç«¯å‘è¾¹ç¼˜è¿ç§»ã€‚

---

> ğŸ”— Related: [[æ€è€ƒ/Transformeræ¶æ„æ¼”åŒ–çš„é€»è¾‘|Transformer æ¶æ„æ¼”åŒ–çš„é€»è¾‘]] Â· [[AI/3-LLM/Inference/KV Cache|KV Cache]] Â· [[AI/3-LLM/Inference/Speculative Decoding|Speculative Decoding]] Â· [[MoE æ·±åº¦è§£æ|MoE æ·±åº¦è§£æ]]
