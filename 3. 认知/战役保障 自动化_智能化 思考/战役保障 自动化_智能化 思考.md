# 战役保障 自动化/智能化 思考

目前战役保障流程繁多复杂，很多事项无法投入足够人力支持，而且依赖人工检查难免疏忽，导致最后保障效果要么成本过高，要么效果不好。

看下如何拆解为自动化的方式：

Step by step

每一步相当于一个算子，算子确认好如何执行了，可以把这个做成一个工具

- 算子角度来看待事项，本质上是智能流程编排
- 节点分类：协同类，数据检查类，xxx 类
- 保障程度分级：比如离线 doris 没啥变化，但实时 doris 会增长，但对应同一个节点比如“doris 扩容”，那么最后扩容的倍数是不同的
串联方式：

1. 先分类
1. 是否能同步异步执行
1. 能否跳过
历史的知识是可以利用的，几年的 wiki

- 数据清洗
- 知识加工（待细化）
## 一、重点流程细化

### 1、**战役目标***

输入：当期目标订单量、当期目标间夜数、当期 qps 预估、基期目标订单量、基期目标间夜数、基期订单量、基期间夜数、基期 qps 峰值等

输出：推荐倍数

#### （1）**确定目标**

比如统计目前日常 200w 间夜，预测目标 500w 间夜，峰值 qps 变化约 8 倍

人工估算形式举例：

- 交易链路：保障目标建议 xxx 倍
- 浏览链路：保障目标建议 xxx 倍
- 其他链路：保障目标建议 xxx 倍
#### （2）对比基期

#### （3） 对比预测

过去预估和实际情况的对比，决定是否需要调整保障目标

### 2、信息收集

事项

流程串联

备注

收集战役信息*

- 保障产品信息*
- 战役需求
1. **战役前 3 周**：开始推送 **负责人确认** 提醒，需要人为维护，变动频率低
1. 默认 ACK：无更改
1. 信息更正：修改数据产品对应的 RD/PM/优先级 信息
1. **战役前 2 周**：开始推送 **需求收集** 提醒，发送大象通知至** 所有录入参与保障的 PM 列表，**
1. ACK：
1. 无新增需求
1. 已新增需求，关联 ones
1. 有新增需求，**ACK 后大象通知 RD**
1. 未 ACK：未 ACK 的接收人 **每天推送一次 **需求收集
1. **战役前 1 周**：截止收集
值班流程*

1. **战役前 2 周**：
1. 给 **所有录入参与保障的PM、RD列表 **发送 **值班人录入提醒**，提供玄武链接跳转
1. 给 **所有录入参与保障的PM、RD列表 ** 发送 **战役文档更新 **提醒
1. [实时沙盘使用常被咨询的问题](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F1661121445)
1. [各主题SQL](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F2228822870)
1. [住宿重点指标实时数据SQL](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F1651697676)
1. ...
1. 
1. **战役前 1 周：**
1. 值班信息汇总：从玄武系统接口抓取值班 RD **信息**、以知识形式录入 业务 / 平台 / 上游公共 值班**信息**
1. 文档信息汇总：将所有的文档
1. 数据清洗（可选）
1. 知识入库（可选）
1. **战役时：值班助手**
1. **发送会议链接**：**自动大象发送通知所有值班人入会**
1. **值班问题记录**：e.g. 竞争力没有数据，直接发送给 chat，返回建立排查思路/处理流程的同时，会记录问题 **时间点（可更改）**、**记录人、建议处理方式、问题定位（复盘时记录）、实际处理方式（复盘时记录）**
1. **监控情况推送**：RD 需要及时检查监控是否正常，如果正常需要 ACK-无异常，复盘 LLM 会归集所有 **存在误判命中的口径**
1. 链接数超过阈值
1. BE 粒度 CPU 利用率超过 xx%
1. scan_cpu_time
1. **战役后**：复盘工具
1. **一键生成战役总结：**
1. 用数口径、问题咨询：
1. 问题数
1. 问题记录：根据 **值班问题记录 **按时间线生成表格
1. 数据故障：
1. 故障数、事件数
1. 故障类型：数据延迟、脏数据
1. 性能瓶颈：生产问题、查询问题
1. 发送战役报告：给预先录入的管理者发送战役总结推送
通过知识沉淀，会持续沉淀值班经验，理论上可以把值班常见问题建立成一个单独的知识库，随着战役次数，知识会越来越丰富

风险摸排*

1. **战役前 2 周：**
1. 用数口径检查（可选、需智能化）：战役期间重点BA手写SQL 正确性检查，给出SQL优化建议
1. 数据降级方案
1. 数据回刷范围
1. **战役前 1 周：**
1. 风险点收集：
1. 推送**战役相关 PM** 大象（e.g. 全员到岗人数可能增多 / QPS上升、查询行为模式有变更等）
1. 收集 **重点基期范围**（e.g. 国庆战役 会重点对比 今年五一 和 去年十一的基期数据）
1. 权限清查**：**
1. 产品权限（后端改造）：拉取接口，自动检查所有 **战役参与人**是否具备权限
1. 门户入口及产品功能权限
1. PC及I版
1. 表权限（待定）
1. 数据清查：
1. **数据准确性**：自动数据汇总，执行清查 SQL 口径，给出 **重点基期 **的指标查询结果，给出辅助分析，对比离线基期数据，如果出现明显异常（比如基期数据量为 0，**给数据 RD 和 PM 发送提醒**）
1. **数据完整性**：指标范围检查（后端改造）：现在一些产品的逻辑是查询为空或报错自动隐藏，这些信息需要**推送至工具**上
1. **战役前 3 天**
1. 封禁期通知：提前 1 天 推送 **所有 RD**
1. 解禁申请流程跳转：https://km.sankuai.com/collabpage/2437627081
TODO：明确具体的调研项（建议宇坤跟进）

TODO：整理产品相关权限的查询及配置入口（建议张力跟进）

TODO：明确具体的数据表的检查项 及 接口的检查项（建议PM跟进）参考[产品检查](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F2215114645)，需要汇总各产品的查询口径，便于值班数据RD排查逻辑问题

TODO：整理各种降级方案（建议宇坤跟进）

Doris权限收回，只检查Hive包括战前和战中BA重点的手写SQL

### 3、性能保障

编排流程

备注

压测扩容

资源

查询流量录制

1. **战役前 2 周：**
1. 生产压测：
1. 单任务粒度：调用单任务压测
1. 分析压测期间的监控元数据 [flink 监控](http%3A%2F%2Frt.data.sankuai.com%2Fgrafana%2Fd%2FfayM2jrWz%2Fflink_job_metrics-public%3ForgId%3D5%26var-group%3Dapp_hotel%26var-job_id%3D1253753%26from%3Dnow-1h%26to%3Dnow%26var-k8s_cluster%3Dyg_flink_cluster)
1. 多任务并行压测依赖流程编排发起
1. 发送压测报告，给出推荐动作，比如任务并发数推荐（基于历史数据）
1. 查询压测：
1. 周知战役相关系统 RD / 数据 RD，确认压测时间，默认放在周一晚 9 点流量低峰期
1. 分析压测期间的元数据 [Doris 监控](http%3A%2F%2Fgrafana-olap.sankuai.com%3A8416%2Fd%2F71ZcE337k%2Fbe%3ForgId%3D1%26var-domain%3Dhbdata-doris%26var-cluster%3DAll%26from%3D1730196623536%26to%3D1730200223536)
1. 发送压测报告，给出推荐动作，需扩容 BE 数
1. **战役前 1 周：**
1. **队列扩容**：确认压测动作的结论，在列表中确认所有任务资源，根据队列情况，给出队列需要申请的资源数（vcore）
1. **任务扩容**：队列扩容 ACK 后，开始**任务扩容**流程，并设置战役后**自动缩容**时间
1. **集群扩容**：给出诊断报告，以及推荐扩容 BE 数
1. **战役时：**
1. 流量录制
TODO：确定流量录制规范，确保录制的流量有效（建议宇坤跟进）点击展开内容流量录制需要注意几个点：录制的机器是否与线上机器完全一致（不一致会导致录制失败）录制条数不要过长（也可能导致失败，具体见[https://tt.sankuai.com/ticket/detail?id=76795473](https%3A%2F%2Ftt.sankuai.com%2Fticket%2Fdetail%3Fid%3D76795473)）关注http、thrift录制文件过期时间，修改需要的录制文件过期时间，录制文件过期时间只会提示场景联系人和关注者http流量录制解决方案：[20240412 域名增加quake流量录制](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F2207220321)

查询压测

TODO：确定压测规范（建议宇坤跟进）住宿自己的查询压测[20240428 查询压测](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F2235786991)

查询压测评估（产品响应性能，瓶颈任务，TOP任务）

生产压测

TODO：整理rt任务压测流程nau压测[Nau作业压测脚本](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F1913202013)

根据压测结果及预估确定扩容量，并确认备用量离线队列实时队列实时任务扩容Doris集群服务器其他起源

TODO：确定扩容的评估方式（建议宇坤跟进）之前沉淀过一些经验[各类资源扩缩容经验](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F2010715155)；[资源调整](https%3A%2F%2Fkm.sankuai.com%2Fcollabpage%2F2215028960)

### 4、监控巡检

监控巡检可以帮助日常或值班时同学迅速发现已经存在的异常，通常我们配置的报警项都是 10min 才开始报警，即使调低阈值也可能因为短暂波动导致报警误报，因此监控巡检可以作为更早的风险触达手段

规则类：

1. 大查询数_5min > 3 报警：推送大查询详情，包括查询 SQL 等元数据信息
1. 超时查询数_5min > 3 报警：推送大查询详情，包括查询 SQL 等元数据信息
1. 查询初始化时间_5min_avg > 20s：推送性能预警
1. scan_cpu_time、fragment_cpu_time、cpu_time、scanner_worker_wait_time 共同敲定一个阈值如果这几项出现需要及时进行报警
1. 异常持续上升 / 打平
1. 异常尖刺
![image](assets/H7JSdtqZWodToAx6LQncSVhrnXe.png)

第一步先做到自动化，对于已有的规则进行监控推送

第二步做到智能化，提升口径精度，优化用户体验

**数据探查**

先提取所有住宿集群下的
